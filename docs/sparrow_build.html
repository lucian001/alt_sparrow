<!DOCTYPE html>
<HTML>
<HEAD>
	<TITLE>Project Sparrow</TITLE>
	<LINK REL="stylesheet" Type="text/css" HREF="sparrow.css" />
</HEAD>
<BODY BGCOLOR="#cdb79e">
	<CENTER><IMG SRC="Sparrow-lg.png" /></CENTER><BR><BR>
<div class="container">
	<CENTER><B>Sparrow is the AMP project which supports running 2 operating systems on the ARM Cortex processor. This is also refered to as homogeneous AMP. It includes 4 Sample Projects to demostrate how to use Sparrow</B></CENTER>

	<H1>Project Descriptions</H1>
	The initial release of Sparrow contains the following projects:
	<H3>baremetal</H3>
	The baremetal app is simply a sample application that turns on and off 4 leds. The point of this demonstration was to show that you can easily take a regular baremetal app and add useful features to it using Sparrow with very little work. The features added to this demo was printfs that show up on the serial console, enabling of the L1 and L2 caches and neon, and setting up the MMU. The code for this is simply 5 function calls, including prints. The layout file contains just 2 memory regions: 1 for memory and other for peripherals. This project is a sample, but is not supported.
	<H3>baremetal_dual</H3>
	This is the same application as baremetal with the exception that it runs on cpu1. Cpu0 is left in a while(1) loop while the work is done on cpu1 however it it easy to replace this with code to do whatever the user wishes. This project is a sample, but is not supported.
	<H3>linux_uCos2</H3>
	This uses Sparrow to run Linux on cpu0 while cpu1 run uCos2. This is a supported project. In the current version uCos2 does very little, but could be replaced with an existing full featured uCos2 application with few modifications. Additionally, uCos2 could be replaced with a stand-alone baremetal application
	<H3>linux_baremetal</H3>
	This uses Sparrow to run Linux on cpu0 which cpu1 runs a baremetal application. This application flashes 2 LEDs. This is different than the linux_uCos2 sample in that the baremetal application is built directly into sparrow. This has the advantage of reducing memory requirements, providing sparrow functionality to the app, and making the build process simple. This is a supported project. An application is included (built in/by sparrow) that can be run within Linux to print/modify the timer settings. I can be found in sparrow/linux_baremetal.ledset/ledset and can be copied to the linux partition of the sd card. Use: <code>ledset -p</code> or set the timer settings:<code> ledset -s 0x100000 0x100000</code>. This will alter the rate at which these leds blink.
	<H3>uCos2_uCos2 (baremetal/baremetal)</H3>
	This runs 2 instances of uCos2 from Sparrow. Either or both of these instances could be replaced with a standalone baremetal application. 

	<H1>Instructions for Building:</H1>
	<H3>Sparrow</H3>
	<OL>
	<LI>This currently must be done on Linux</LI>
	<LI><code>export CROSS_COMPILE=arm-linux-gnueabihf-</code> This must be the prefix to your arm compiler name</LI>
	<LI><code>tar -xvf sparrow.tgz</code></LI>
	<LI><code>cd sparrow</code></LI>
	<LI></I>Optional: Edit the config.py file to have the ip address of your tftp server and board IP</I></LI>
	<LI><code>make</code></LI>
	<LI>This will build 4 projects:<pre>
*** Created bin/baremetal/sparrow.bin ***
*** Created bin/linux_baremetal/sparrow.bin ***
*** Created bin/linux_uCos2/sparrow.bin ***
*** Created bin/baremetal_dual/sparrow.bin ***
*** Created bin/uCos2_uCos2/sparrow.bin ***
</pre>
	</OL>

	<H3>Linux</H3>
	<OL>
	<LI>This must be compiled on Linux</LI>
	<LI><code>export CROSS_COMPILE=arm-linux-gnueabihf-</code></LI>
	<LI><code>export ARCH=arm</code></LI>
	<LI><code>tar -xvf linux-socfpga-amp.tgz</code></LI>
	<LI><code>cd linux-socfpga-amp</code></LI>
	<LI><code>git checkout socfpga-3.11-amp</code> This could be socfpga-3.10-amp or socfpga-3.6-amp</LI>
	<LI><code>make socfpga_defconfig</code></LI>
	<LI><code>make dtbs</code></LI>
	<LI><code>make uImage LOADADDR=0x8000</code></LI>
	<LI>Output will be arch/arm/boot/uImage and arch/arm/boot/dts/socfpga_cyclone5.dtb</LI>
	</OL>

	<H3>uCos2</H3>
	<OL>
	<LI>This is the version of uCos2 used in the linux_uCos2 sample. This can be compiled on any system with Code Sourcery installed</LI>
	<LI><code>tar -xvf ucosii.tgz</code></LI>	
	<LI><code>cd ucosii</code></LI>
	<LI><code>cs-make CONFIG_AMP=1 RAM_BASE=0x3dc00000 RAM_SIZE=0x100000 LOG_ADDRESS=0x3fe00000 LOG_SIZE=0x100000</code>
		<UL><LI>RAM_BASE is the address where ucosii should be loaded. To find out what the proper address is, view your sparrow/bin/linux_uCos2.map file and look at the System Map. There is an entry for "uCos2 Memory". You will need the physical address</LI>
		<LI>RAM_SIZE is how much memory was allocated to uCos2. This can be found in the same sparrow file in the Map for uCosii</LI>
		<LI>Since the uART is being used by Linux, uCos2 must instead log to memory. LOG_ADDRESS is where in physical memory the uCos2 logs will be written to. If this value is left blank then uCos2 will log to an internal buffer which will not be made available to Linux. This LOG Address will be used in the Linux dumpLog utility to view these logs. It can be found in the same map file under "Map for uCosii: OS1's Log Buffer"</LI>
		<LI>LOG_SIZE is the size of the log. It can also be found in the same map file under "Map for uCosii: OS1's Log Buffer"</LI>
		</UL>
	</OL>
	<H3>dual uCos2</H3>
	<OL>
	<LI>This is the version of uCos2 used in the uCos2_uCos2 sample. The following will compile both instances of the operating system.</LI>
	<LI><code>tar -xvf ucosii2.tgz</code></LI>
	<LI><code>cd ucosii</code></LI>
	<LI><code>./build.sh</code></LI>

	</OL>
	<H1>Running a Project</H1>
	There are several ways to load and run each of the projects. Which one to use will depend on whether you are putting together a stand-alone demo or actively developing, as well as your preferences. 
	<H3>Copy Files to the SD Card</H3>
	This will create a stand-alone demo that will involve putting the sd-card into the board, turning it on, and watching it run. When presenting to a customer this is the safest option for a working demo and will most closely resemble how their product will run. In this description we will install the linux_baremetal application to the sd_card
	<OL>
	<LI>Begin by downloading the sd_image-cyclone5.bin.gz and burning it to the card<BR><code>gunzip -c sd_image_cyclone5.bin.gz | sudo dd of=/dev/sdb</code> If you have a card with a recent install then you can use that and skip this step. You may also use an sd_image from a recent release
	<LI>After burning the image you may need to unplug and replug the card back in for the OS to recognise the new filesystem</LI>
	<LI>Mount the DOS partition. On windows this is automatic. On Linux you should run <code>dmesg | tail</code> in order to see what device name has been assigned to the card, then use: <code>sudo mount /dev/sdb1 /media/sd1</code> where /dev/sdb1 is the device name from dmesg. /media/sd1 is a directory that you will need to create for mounting</LI>
	<LI>Copy sparrow: For sparrow you will need the file sparrow/bin/{project}.bin <code> cp ~/sparrow/bin/linux_baremetal.bin /media/sd1</code></LI>
	<LI>Copy the new uboot script: This can be found in sparrow/bin/ {project}/uboot.scr <code>cp ~/sparrow/bin/linux_baremetal/uboot.scr /media/sd1</code></LI>. This script will tell uboot which files to load at boot time and where to put them.
	<LI>Copy Linux: <code>cp ~/linux-socfpga-amp/arch/arm/boot/uImage /media/sd1</code></LI>
	<LI>Copy the dtb: <code>cp ~/linux-socfpga-amp/arch/arm/boot/dts/socfpga_cyclone5.dtb /media/sd1</code></LI>
	<LI>Copy uCos2: If you are running the uCos2 demo instead of linux_baremetal then you will need to copy ucosii.bin to /media/sd1</LI>
	<LI>unmount: <code>sudo umount /media/sd1</code></LI>
	<LI>Put the card in the board and boot. You may connect to the terminal to log into Linux (username:root, no password). For the linux_baremetal projec you should see LEDS flashing</LI>
	</OL>

	<H3>Booting via TFTP</H3>
	When making changes to a project you may wish to boot the system via tftp. This prevents you from having to update the card often. Installing a tftp server is trivial on a Linux machine and Windows versions exist as well. I highly recommend this.
	<OL>
	<LI>When booting, log into the terminal and press a key before the uboot countdown expires. This will allow you to enter commands on the uboot terminal</LI>
	<LI>To load the uboot script that was written to the card use the following: <code> run callscript</code>. This will load all the variables that tell uboot which files to load and where</LI>
	<LI>To load all of the files via tftp, enter: <code> run tfload</code></LI>
	<LI>If you wish to load some file from the sd card and others via tftp you can enter: <code> run mmcload </code> followed by:<code> run tfsparrow</code> to overwrite sparrow with the version from tftp. There is a tf command to load each of the files. Use printenv to see these functions</LI>
	<LI>After the files are loaded use <code>run mmcboot</code>
	</OL>

	<H3>Booting a different project via TFTP</H3>
	If you have one project (or a fresh sd_image) loaded on a card and want to run an entirely different project from tftp you can do that too:
	<OL>
	<LI>When booting, log into the terminal and press a key before the uboot countdown expires. This will allow you to enter commands on the uboot terminal</LI>
	<LI>In your host system type copy the contents of ~/sparrow/gen/{project}/boot.script to the the clipboard <code> cat ~/sparrow/gen/linux_baremetal/boot.script</code>
	<LI>Paste this to the terminal</LI>
	<LI>At this point you can enter: <code> run tfload </code> followed by <code>run mmcboot</code>
	</OL>

	<H3>Loading files from DS-5</H3>
	If DS-5 has access to your sparrow directory then you can load it directly into ds5. This will give you debugging symbols
	<OL>
	<LI>When booting, log into the terminal and press a key before the uboot countdown expires. This will allow you to enter commands on the uboot terminal</LI>
	<LI>Connect via DS-5</LI>
	<LI>Pause the system using the debugger</LI>
	<LI>In the DS-5 command window enter <code>loadfile "~/sparrow/baremetal_dual/sparrow.axf"</code></LI>
	<LI>Continue the sytem</LI>
	<LI>At the uboot command line enter: <code>go ${sparrowstart}</code></LI>
	</OL>
</div>

</BODY>
</HTML>
